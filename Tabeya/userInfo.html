<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservation Information</title>
    <link rel="stylesheet" href="CSS/userInfoDesign.css">
   
</head>
<body>
    <div class="background">
        <img src="Photo/Reservation.jpg" alt="Background">
        <h1 class="quote">YOUR<br>SATISFACTION<br>IS OUR<br>PASSION</h1>
        <div class="rectangle-panel">
            <h1 class="product-selection-label">CHOOSE YOUR PREFERRED PRODUCTS</h1>
            <div class="continue-section">
                <button class="continue-btn" onclick="initializeProductSelection()">Continue to Product Selection</button>
            </div>
        </div>
    </div>  

    <!-- Product Selection Panel -->
    <div id="product-selection-panel">
        <div class="product-category-nav">
            <a href="#" data-category="PLATTER" class="active">Platter</a>
            <a href="#" data-category="RICE MEAL">Rice Meal</a>
            <a href="#" data-category="RICE">Rice</a>
            <a href="#" data-category="NOODLES & PASTA">Bilao</a>
            <a href="#" data-category="SPAGHETTI MEAL">Spaghetti Meals</a>
            <a href="#" data-category="SNACKS">Snacks</a>
            <a href="#" data-category="DESSERT">Dessert</a>
            <a href="#" data-category="DRINKS & BEVERAGES">Drinks</a>
        </div>
        <div id="product-groups"></div>
        <div class="panel-controls">
            <div class="total-price-container">
                Total: ‚Ç±<span id="total-price">0.00</span>
            </div>
            <div class="btn-group">
                <button class="cancel-btn" onclick="closeProductSelection()">Cancel</button>
                <button class="submit-btn" onclick="showConfirmationPopup()">Confirm Order</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Popup -->
    <div class="popup-overlay" id="confirmation-popup">
        <div class="popup-content">
            <p>Confirm your order?<br><br><strong style="font-size:24px;color:#bc1823;">‚Ç±<span id="total-reservation"></span></strong></p>
            <button onclick="confirmReservation()">Yes, Submit</button>
            <button onclick="closePopup('confirmation-popup')">Cancel</button>
        </div>
    </div>

    <!-- Success Popup -->
    <div class="popup-overlay" id="success-popup">
        <div class="popup-content">
            <p style="font-size:40px;margin-bottom:10px;">‚úÖ</p>
            <p><strong>Order Received!</strong><br><br>Our staff will contact you shortly for delivery details.<br><br>Thank you for choosing <strong style="color:#bc1823;">TABEYA!</strong></p>
            <button onclick="redirectToReservation()">Done</button>
        </div>
    </div>

    <script>
    let allProducts = [];
    let selectedProducts = {};
    let totalAmount = 0;

    async function initializeProductSelection() {
        try {
            const productGroups = document.getElementById('product-groups');
            productGroups.innerHTML = '<div class="loading-spinner"></div>';
            document.getElementById('product-selection-panel').style.display = 'flex';

            const response = await fetch('fetch_products.php');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

            const data = await response.json();
            if (!data.success) throw new Error(data.message || 'Failed to fetch products');

            allProducts = data.products || [];
            console.log('Loaded', allProducts.length, 'products');

            displayProducts(filterProductsByCategory('PLATTER'));
            setupCategoryNavigation();

        } catch (error) {
            console.error('Error:', error);
            alert('Failed to load products: ' + error.message);
            closeProductSelection();
        }
    }

    function filterProductsByCategory(categoryName) {
        return allProducts.filter(p => p.Category && p.Category.toUpperCase() === categoryName.toUpperCase());
    }

    function displayProducts(products) {
        const container = document.getElementById('product-groups');
        container.innerHTML = '';

        if (products.length === 0) {
            container.innerHTML = '<p class="no-products">No products in this category.</p>';
            return;
        }

        products.forEach(product => {
            const qty = selectedProducts[product.ProductID]?.quantity || 0;
            const price = parseFloat(product.Price);
            const img = product.Image || '';
            const name = product.ProductName || 'Product';
            const desc = product.Description || 'Delicious dish from Tabeya';

            const card = document.createElement('div');
            card.className = 'product-card';

            card.innerHTML = `
                <div class="product-image">
                    ${img ? `<img src="${img}" alt="${name}" onerror="this.style.display='none';this.nextElementSibling.style.display='block'"><span class="placeholder-icon" style="display:none">üçΩÔ∏è</span>` : '<span class="placeholder-icon">üçΩÔ∏è</span>'}
                </div>
                <div class="product-info">
                    <div class="product-name">${name}</div>
                    <div class="product-description">${desc}</div>
                    <div class="product-price">‚Ç±${price.toFixed(2)}</div>
                    <div class="quantity-controls">
                        <button class="qty-btn minus" data-id="${product.ProductID}" data-price="${price}" data-name="${encodeURIComponent(name)}">‚àí</button>
                        <span class="qty-display ${qty > 0 ? 'has-qty' : ''}" id="qty-${product.ProductID}">${qty}</span>
                        <button class="qty-btn plus" data-id="${product.ProductID}" data-price="${price}" data-name="${encodeURIComponent(name)}">+</button>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });

        // Event delegation for buttons
        container.querySelectorAll('.qty-btn').forEach(btn => {
            btn.addEventListener('click', handleQtyClick);
        });
    }

    function handleQtyClick(e) {
        const btn = e.currentTarget;
        const id = btn.dataset.id;
        const price = parseFloat(btn.dataset.price);
        const name = decodeURIComponent(btn.dataset.name);
        const isPlus = btn.classList.contains('plus');

        const currentQty = selectedProducts[id]?.quantity || 0;
        const newQty = isPlus ? currentQty + 1 : Math.max(0, currentQty - 1);

        if (newQty > 0) {
            selectedProducts[id] = { id, name, price, quantity: newQty };
        } else {
            delete selectedProducts[id];
        }

        const display = document.getElementById(`qty-${id}`);
        if (display) {
            display.textContent = newQty;
            display.classList.toggle('has-qty', newQty > 0);
        }

        updateTotal();
    }

    function setupCategoryNavigation() {
        document.querySelectorAll('.product-category-nav a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('.product-category-nav a').forEach(a => a.classList.remove('active'));
                link.classList.add('active');
                displayProducts(filterProductsByCategory(link.dataset.category));
            });
        });
    }

    function updateTotal() {
        totalAmount = Object.values(selectedProducts).reduce((sum, p) => sum + (p.price * p.quantity), 0);
        document.getElementById('total-price').textContent = totalAmount.toFixed(2);
    }

    function closeProductSelection() {
        document.getElementById('product-selection-panel').style.display = 'none';
    }

    function showConfirmationPopup() {
        if (Object.keys(selectedProducts).length === 0) {
            alert('Please select at least one product.');
            return;
        }
        document.getElementById('total-reservation').textContent = totalAmount.toFixed(2);
        document.getElementById('confirmation-popup').style.display = 'flex';
    }

    function closePopup(id) {
        document.getElementById(id).style.display = 'none';
    }

    async function confirmReservation() {
        const items = Object.values(selectedProducts).map(p => ({
            id: p.id, name: p.name, quantity: p.quantity, price: p.price
        }));

        if (items.length === 0) return alert('Please select products.');

        const user = JSON.parse(localStorage.getItem('currentUser'));
        if (!user) return alert('Please log in.'), window.location.href = 'Login.html';

        const formData = sessionStorage.getItem('cateringFormData');
        if (!formData) return alert('Please fill catering form first.'), window.location.href = 'CaterReservation.html';

        const catering = JSON.parse(formData);
        const body = new FormData();
        body.append('customer_id', user.customerId || '');
        body.append('customer_name', `${user.firstName || ''} ${user.lastName || ''}`);
        body.append('customer_email', user.email || '');
        body.append('customer_phone', user.contactNumber || '');
        body.append('event_date', catering.date || '');
        body.append('event_time', catering.time || '');
        body.append('guests', catering.guests || '1');
        body.append('event_type', catering.eventType || '');
        body.append('total_price', totalAmount.toFixed(2));
        body.append('selected_products', JSON.stringify(items));

        const btn = document.querySelector('#confirmation-popup button:first-of-type');
        btn.textContent = 'Saving...';
        btn.disabled = true;

        try {
            const res = await fetch('save_product_reservation.php', {
                method: 'POST', body, headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            const data = await res.json();

            if (data.status === 'success') {
                closePopup('confirmation-popup');
                document.getElementById('success-popup').style.display = 'flex';
            } else {
                throw new Error(data.message || 'Error');
            }
        } catch (err) {
            alert('Error: ' + err.message);
            btn.textContent = 'Yes, Submit';
            btn.disabled = false;
        }
    }

    function redirectToReservation() {
        sessionStorage.removeItem('cateringFormData');
        window.location.href = 'CaterReservation.html';
    }

    document.addEventListener('DOMContentLoaded', () => {
        if (!localStorage.getItem('currentUser')) {
            alert('Please log in first.');
            return window.location.href = 'Login.html';
        }
        if (!sessionStorage.getItem('cateringFormData')) {
            alert('Please complete the catering form first.');
            return window.location.href = 'CaterReservation.html';
        }
    });
    </script>
</body>
</html>
